<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Êï∞ÊçÆÂèØËßÜÂåñÈÖçÁΩÆÁâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #000; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 10px; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
        "three": "https://esm.sh/three@0.174.0",
        "@react-three/fiber": "https://esm.sh/@react-three/fiber@9.0.0?external=react,react-dom,three",
        "@react-three/drei": "https://esm.sh/@react-three/drei@10.0.0?external=react,react-dom,three,@react-three/fiber",
        "lucide-react": "https://esm.sh/lucide-react@0.475.0?external=react"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        /** @jsx React.createElement */
        import React, { useRef, useMemo, useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Canvas, useFrame } from '@react-three/fiber';
        import { 
          OrbitControls, PerspectiveCamera, Environment, ContactShadows, 
          MeshReflectorMaterial, PerformanceMonitor, AdaptiveDpr, AdaptiveEvents,
          Grid, Text, Billboard, Sphere, Float
        } from '@react-three/drei';
        import * as THREE from 'three';
        import { Play, Pause, RotateCcw, Monitor, Camera, MousePointer2, Settings2, X, Layout, BarChart3, TrendingUp } from 'lucide-react';

        // ==========================================
        // Ê†∏ÂøÉÂÖ®Â±ÄÈÖçÁΩÆ (Âú®ËøôÈáå‰øÆÊîπ‰Ω†ÁöÑÂÜÖÂÆπ)
        // ==========================================
        const CONFIG = {
          ui: {
            title: "‰∏âÁª¥",
            highlightTitle: "Âä®ÊÄÅÊï∞ÊçÆÁúãÊùø",
            subTitle: "HIGH-END VISUALIZATION ENGINE",
            defaultMode: 'BAR' // ÂèØÈÄâ 'BAR' (Êü±Áä∂Âõæ) Êàñ 'LINE' (ÊäòÁ∫øÂõæ)
          },
          data: [
            { id: '1', name: 'Ë∂äÂçó', value: 3.5, unit: 'Áôæ‰∏áÂê®', color: '#ff4d4d', flag: 'üáªüá≥' },
            { id: '2', name: 'Èü©ÂõΩ', value: 4.2, unit: 'Áôæ‰∏áÂê®', color: '#4d79ff', flag: 'üá∞üá∑' },
            { id: '3', name: 'Êó•Êú¨', value: 6.1, unit: 'Áôæ‰∏áÂê®', color: '#ffffff', flag: 'üáØüáµ' },
            { id: '4', name: 'Â¢®Ë•øÂì•', value: 8.9, unit: 'Áôæ‰∏áÂê®', color: '#006847', flag: 'üá≤üáΩ' },
            { id: '5', name: 'Âæ∑ÂõΩ', value: 9.2, unit: 'Áôæ‰∏áÂê®', color: '#000000', flag: 'üá©üá™' },
            { id: '6', name: '‰øÑÁΩóÊñØ', value: 11.5, unit: 'Áôæ‰∏áÂê®', color: '#1e88e5', flag: 'üá∑üá∫' },
            { id: '7', name: 'Â∑¥Ë•ø', value: 19.8, unit: 'Áôæ‰∏áÂê®', color: '#ffeb3b', flag: 'üáßüá∑' },
            { id: '8', name: 'ÁæéÂõΩ', value: 33.2, unit: 'Áôæ‰∏áÂê®', color: '#283593', flag: 'üá∫üá∏' },
            { id: '9', name: '‰∏≠ÂõΩ', value: 88.3, unit: 'Áôæ‰∏áÂê®', color: '#d32f2f', flag: 'üá®üá≥' },
          ].sort((a, b) => a.value - b.value)
        };

        const CameraView = { FREE: 'FREE', FRONT: 'FRONT', TOP: 'TOP', SIDE: 'SIDE', CINEMATIC: 'CINEMATIC', PANORAMA: 'PANORAMA' };

        // --- 3D ÁªÑ‰ª∂ ---
        const BOX_GEOM = new THREE.BoxGeometry(2, 1, 2);
        const PLANE_GEOM = new THREE.PlaneGeometry(3.5, 3.5);

        const Bar = ({ item, index, total, progress, active }) => {
          const materialRef = useRef();
          const growthProgress = Math.max(0, Math.min(1, progress - index));
          const isStarted = progress > index;
          const fullHeight = item.value * 0.1;
          const currentHeight = Math.max(0.01, fullHeight * growthProgress);
          const xPos = (index - (total - 1) / 2) * 3.5;

          useFrame(() => {
            if (materialRef.current) {
              const targetEmissive = active ? 3.0 : (progress >= index + 1 ? 0.5 : 0);
              materialRef.current.emissiveIntensity = THREE.MathUtils.lerp(materialRef.current.emissiveIntensity, targetEmissive, 0.1);
            }
          });

          return (
            <group position={[xPos, 0, 0]}>
              <mesh geometry={PLANE_GEOM} rotation={[-Math.PI / 2, 0, 0]} position={[0, -0.01, 0]}>
                <meshBasicMaterial color={item.color} transparent opacity={0.1 * Math.min(1, growthProgress * 2)} />
              </mesh>
              <mesh geometry={BOX_GEOM} scale={[1, currentHeight, 1]} position={[0, currentHeight / 2, 0]}>
                <meshStandardMaterial ref={materialRef} color={item.color} emissive={item.color} emissiveIntensity={0} roughness={0.2} metalness={0.8} transparent opacity={Math.min(1, growthProgress * 2)} />
              </mesh>
              {isStarted && (
                <Billboard position={[0, fullHeight + 4, 0]}>
                  <Text position={[0, 2.2, 0]} fontSize={2.5} fillOpacity={Math.min(1, growthProgress * 2)}>{item.flag}</Text>
                  <Text position={[0, 0.5, 0]} fontSize={0.7} fontWeight="bold" color="#fff" fillOpacity={Math.min(1, growthProgress * 2)}>{item.name}</Text>
                  <Text position={[0, -0.8, 0]} fontSize={1.4} fontWeight="900" color={active ? "#fff" : item.color} fillOpacity={Math.min(1, growthProgress * 2)}>{(item.value * growthProgress).toFixed(1)}</Text>
                </Billboard>
              )}
            </group>
          );
        };

        const LineNode = ({ item, prevItem, index, total, progress, active }) => {
          const growthProgress = Math.max(0, Math.min(1, progress - index));
          const isStarted = progress > index;
          const targetHeight = item.value * 0.1;
          const xPos = (index - (total - 1) / 2) * 3.5;
          const prevX = index > 0 ? (index - 1 - (total - 1) / 2) * 3.5 : xPos;
          const prevHeight = prevItem ? prevItem.value * 0.1 : 0;

          const segment = useMemo(() => {
            if (!prevItem || index === 0 || !isStarted) return null;
            const start = new THREE.Vector3(prevX, prevHeight, 0);
            const end = new THREE.Vector3(xPos, targetHeight, 0);
            const currentEnd = start.clone().lerpVectors(start, end, growthProgress * (2 - growthProgress));
            const direction = new THREE.Vector3().subVectors(currentEnd, start);
            const length = direction.length();
            if (length < 0.01) return null;
            const midpoint = new THREE.Vector3().addVectors(start, currentEnd).multiplyScalar(0.5);
            const quaternion = new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction.clone().normalize());
            return { midpoint, quaternion, length };
          }, [prevItem, index, prevX, prevHeight, xPos, targetHeight, isStarted, growthProgress]);

          return (
            <group>
              {segment && (
                <mesh position={segment.midpoint} quaternion={segment.quaternion}>
                  <cylinderGeometry args={[0.1, 0.1, segment.length, 12]} />
                  <meshStandardMaterial color={item.color} emissive={item.color} emissiveIntensity={active ? 10 : 2} metalness={1} roughness={0} transparent opacity={Math.min(1, growthProgress * 2)} />
                </mesh>
              )}
              {isStarted && (
                <group position={[xPos, targetHeight, 0]}>
                  <Sphere args={[0.35, 32, 32]}>
                    <meshStandardMaterial color={item.color} emissive={item.color} emissiveIntensity={active ? 10 : 1} metalness={1} roughness={0} transparent opacity={Math.min(1, growthProgress * 2)} />
                  </Sphere>
                  <Billboard position={[0, 5, 0]}>
                    <Text position={[0, 2.5, 0]} fontSize={3}>{item.flag}</Text>
                    <Text position={[0, 0.6, 0]} fontSize={0.8} fontWeight="black" color="#fff">{item.name}</Text>
                    <Text position={[0, -1, 0]} fontSize={1.8} fontWeight="black" color={active ? "#fff" : item.color}>{(item.value * (progress > index + 1 ? 1 : growthProgress)).toFixed(1)}</Text>
                  </Billboard>
                </group>
              )}
            </group>
          );
        };

        const CameraController = ({ view, progress, data, isPlaying, camAngle, camDistance }) => {
          const { camera } = useThree();
          const controlsRef = useRef();
          const total = data.length;

          useFrame(() => {
            if (!controlsRef.current) return;
            const currentIdx = Math.max(0, Math.min(total - 1, progress));
            const xPos = (currentIdx - (total - 1) / 2) * 3.5;
            const height = data[Math.floor(currentIdx)].value * 0.1;

            if (view === CameraView.CINEMATIC) {
              const rad = (camAngle * Math.PI) / 180;
              controlsRef.current.target.lerp(new THREE.Vector3(xPos, height / 2 + 2, 0), 0.05);
              camera.position.lerp(new THREE.Vector3(xPos + Math.sin(rad) * camDistance, height / 2 + 10, Math.cos(rad) * camDistance), 0.05);
              controlsRef.current.update();
            } else if (view === CameraView.PANORAMA) {
              camera.position.lerp(new THREE.Vector3(0, 30, 80), 0.04);
              controlsRef.current.target.lerp(new THREE.Vector3(0, 5, 0), 0.04);
              controlsRef.current.update();
            }
          });

          return <OrbitControls ref={controlsRef} makeDefault enableDamping dampingFactor={0.05} enabled={view === CameraView.FREE || !isPlaying} />;
        };

        // --- ÂÆπÂô®‰∏é UI ---
        const App = () => {
          const [progress, setProgress] = useState(0);
          const [isPlaying, setIsPlaying] = useState(true);
          const [view, setView] = useState(CameraView.CINEMATIC);
          const [visMode, setVisMode] = useState(CONFIG.ui.defaultMode);
          const [playbackSpeed, setPlaybackSpeed] = useState(1.0);

          useEffect(() => {
            if (!isPlaying) return;
            const animate = () => {
              setProgress(p => {
                if (p >= CONFIG.data.length) { setIsPlaying(false); setView(CameraView.PANORAMA); return CONFIG.data.length; }
                return p + (0.004 * playbackSpeed);
              });
              requestAnimationFrame(animate);
            };
            const id = requestAnimationFrame(animate);
            return () => cancelAnimationFrame(id);
          }, [isPlaying, playbackSpeed]);

          return (
            <div className="flex flex-col w-full h-[100dvh] bg-black text-white select-none">
              <div className="relative flex-grow">
                <div className="absolute top-0 left-0 p-8 z-10 pointer-events-none">
                  <h1 className="text-xl md:text-3xl font-black italic uppercase">
                    {CONFIG.ui.title} <span className="text-blue-500">{CONFIG.ui.highlightTitle}</span>
                  </h1>
                  <p className="text-blue-400 text-[9px] font-bold tracking-[0.4em] opacity-50">{CONFIG.ui.subTitle}</p>
                </div>
                <Canvas dpr={[1, 2]}>
                  <Environment preset="night" /><fog attach="fog" args={['#000', 30, 400]} />
                  <CameraController view={view} progress={progress} data={CONFIG.data} isPlaying={isPlaying} camAngle={30} camDistance={45} />
                  <directionalLight position={[10, 20, 10]} intensity={1.5} />
                  <group>
                    <Grid infiniteGrid sectionColor="#111" cellColor="#050505" />
                    {visMode === 'BAR' ? 
                      CONFIG.data.map((item, idx) => <Bar key={item.id} item={item} index={idx} total={CONFIG.data.length} progress={progress} active={Math.floor(progress) === idx} />) :
                      CONFIG.data.map((item, idx) => <LineNode key={item.id} item={item} prevItem={idx > 0 ? CONFIG.data[idx-1] : null} index={idx} total={CONFIG.data.length} progress={progress} active={Math.floor(progress) === idx} />)
                    }
                    <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, -0.02, 0]}>
                      <planeGeometry args={[1000, 1000]} />
                      <MeshReflectorMaterial color="#080808" metalness={0.5} mirror={0.8} />
                    </mesh>
                  </group>
                </Canvas>
              </div>
              <div className="bg-[#050505] border-t border-white/5 p-4 flex flex-col items-center">
                <div className="w-full h-1 bg-white/10 mb-4 relative">
                    <div className="absolute h-full bg-blue-500 transition-all" style={{ width: `${(progress / CONFIG.data.length) * 100}%` }} />
                </div>
                <div className="flex gap-4">
                  <button onClick={() => setIsPlaying(!isPlaying)} className="p-4 bg-blue-600 rounded-full">{isPlaying ? <Pause /> : <Play />}</button>
                  <button onClick={() => { setProgress(0); setIsPlaying(true); setView(CameraView.CINEMATIC); }} className="p-4 bg-white/10 rounded-full"><RotateCcw /></button>
                  <button onClick={() => setVisMode(v => v === 'BAR' ? 'LINE' : 'BAR')} className="p-4 bg-white/10 rounded-full">Ê®°ÂºèÂàáÊç¢</button>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
