<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Êï∞ÊçÆÁúãÊùø - ÊúÄÁªàË°•Âº∫Áâà</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #000; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 10px; }
        /* ÈÅøÂÖçÁßªÂä®Á´ØÂºπÊÄßÊªöÂä®Âπ≤Êâ∞ 3D ‰∫§‰∫í */
        html, body { position: fixed; width: 100%; height: 100%; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
        "three": "https://esm.sh/three@0.174.0",
        "@react-three/fiber": "https://esm.sh/@react-three/fiber@9.0.0?external=react,react-dom,three",
        "@react-three/drei": "https://esm.sh/@react-three/drei@10.0.0?external=react,react-dom,three,@react-three/fiber",
        "lucide-react": "https://esm.sh/lucide-react@0.475.0?external=react"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        /** @jsx React.createElement */
        /** @jsxFrag React.Fragment */
        import React, { useRef, useMemo, useState, useEffect, Suspense } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Canvas, useFrame, useThree } from '@react-three/fiber';
        import { 
          OrbitControls, PerspectiveCamera, Environment, ContactShadows, 
          MeshReflectorMaterial, PerformanceMonitor, AdaptiveDpr, AdaptiveEvents,
          Grid, Text, Billboard, Sphere, Float
        } from '@react-three/drei';
        import * as THREE from 'three';
        import { Play, Pause, RotateCcw, Monitor, Camera, MousePointer2, Settings2, X, Layout, BarChart3, TrendingUp } from 'lucide-react';

        // ==========================================
        // 1. ÂÖ®Â±ÄÈÖçÁΩÆÂå∫
        // ==========================================
        
        const CONFIG = {
          ui: {
            title: "2024Âπ¥",
            highlightTitle: "‰∏≠ÂõΩÁúÅ‰ªΩ GDP TOP 10",
            subTitle: "Êï∞ÊçÆÊù•Ê∫êÔºöÂêÑÁúÅÁªüËÆ°Â±ÄÂàùÊ≠•Ê†∏ÁÆóÊï∞ (Âçï‰ΩçÔºö‰∏á‰∫øÂÖÉ)",
            defaultMode: 'BAR' // Êé®Ëçê‰ΩøÁî®Êü±Áä∂ÂõæÂ±ïÁ§∫ÊéíÂêçÂØπÊØî
          },
          data: [
            { id: '10', name: '‰∏äÊµ∑', value: 4.90, unit: '‰∏á‰∫ø', color: '#9c27b0', flag: 'üèôÔ∏è' },
            { id: '9',  name: 'ÂÆâÂæΩ', value: 4.95, unit: '‰∏á‰∫ø', color: '#795548', flag: 'üåÑ' },
            { id: '8',  name: 'Á¶èÂª∫', value: 5.56, unit: '‰∏á‰∫ø', color: '#00bcd4', flag: 'üåä' },
            { id: '7',  name: 'ÊπñÂåó', value: 5.75, unit: '‰∏á‰∫ø', color: '#4caf50', flag: 'ü¶¢' },
            { id: '6',  name: 'Ê≤≥Âçó', value: 6.05, unit: '‰∏á‰∫ø', color: '#ffeb3b', flag: 'üåæ' },
            { id: '5',  name: 'ÂõõÂ∑ù', value: 6.30, unit: '‰∏á‰∫ø', color: '#ff9800', flag: 'üêº' },
            { id: '4',  name: 'ÊµôÊ±ü', value: 8.70, unit: '‰∏á‰∫ø', color: '#2196f3', flag: 'üçµ' },
            { id: '3',  name: 'Â±±‰∏ú', value: 9.60, unit: '‰∏á‰∫ø', color: '#3f51b5', flag: '‚õ∞Ô∏è' },
            { id: '2',  name: 'Ê±üËãè', value: 13.28, unit: '‰∏á‰∫ø', color: '#f44336', flag: 'üèÆ' },
            { id: '1',  name: 'Âπø‰∏ú', value: 13.92, unit: '‰∏á‰∫ø', color: '#d32f2f', flag: 'ü¶Å' },
          ].sort((a, b) => a.value - b.value) // ÂçáÂ∫èÊéíÂàóÔºåËÆ©ÊúÄÂ§ßÁöÑÊéíÂú®ÊúÄÂêéÔºåÂä®ÁîªÊïàÊûúÊõ¥ÈúáÊíº
        };

        const CameraView = { FREE: 'FREE', PANORAMA: 'PANORAMA', CINEMATIC: 'CINEMATIC' };

        // ==========================================
        // 2. 3D Â≠êÁªÑ‰ª∂
        // ==========================================
        const Bar = ({ item, index, total, progress, active }) => {
          const materialRef = useRef();
          const growth = Math.max(0, Math.min(1, progress - index));
          const height = Math.max(0.01, item.value * 0.1 * growth);
          const xPos = (index - (total - 1) / 2) * 3.5;

          useFrame(() => {
            if (materialRef.current) {
              const emissive = active ? 3 : (progress >= index + 1 ? 0.4 : 0);
              materialRef.current.emissiveIntensity = THREE.MathUtils.lerp(materialRef.current.emissiveIntensity, emissive, 0.1);
            }
          });

          return (
            <group position={[xPos, 0, 0]}>
              <mesh position={[0, height / 2, 0]}>
                <boxGeometry args={[2, 1, 2]} scale={[1, height, 1]} />
                <meshStandardMaterial ref={materialRef} color={item.color} emissive={item.color} metalness={0.8} roughness={0.2} transparent opacity={Math.min(1, growth * 2)} />
              </mesh>
              {growth > 0.1 && (
                <Billboard position={[0, item.value * 0.1 + 4, 0]}>
                  <Text position={[0, 2, 0]} fontSize={2}>{item.flag}</Text>
                  <Text position={[0, 0.5, 0]} fontSize={0.7} color="#fff">{item.name}</Text>
                  <Text position={[0, -0.8, 0]} fontSize={1.2} fontWeight="900" color={active ? "#fff" : item.color}>{(item.value * growth).toFixed(1)}</Text>
                </Billboard>
              )}
            </group>
          );
        };

        const LineNode = ({ item, prevItem, index, total, progress, active }) => {
          const growth = Math.max(0, Math.min(1, progress - index));
          const targetY = item.value * 0.1;
          const xPos = (index - (total - 1) / 2) * 3.5;
          const prevX = index > 0 ? (index - 1 - (total - 1) / 2) * 3.5 : xPos;
          const prevY = prevItem ? prevItem.value * 0.1 : 0;

          const segment = useMemo(() => {
            if (!prevItem || growth <= 0) return null;
            const start = new THREE.Vector3(prevX, prevY, 0);
            const end = new THREE.Vector3(xPos, targetY, 0).lerpVectors(start, new THREE.Vector3(xPos, targetY, 0), growth);
            const dir = new THREE.Vector3().subVectors(end, start);
            return { pos: new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5), quat: new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0, 1, 0), dir.clone().normalize()), len: dir.length() };
          }, [prevItem, growth, prevX, prevY, xPos, targetY]);

          return (
            <group>
              {segment && (
                <mesh position={segment.pos} quaternion={segment.quat}>
                  <cylinderGeometry args={[0.1, 0.1, segment.len, 8]} />
                  <meshStandardMaterial color={item.color} emissive={item.color} emissiveIntensity={active ? 5 : 1} transparent opacity={Math.min(1, growth * 2)} />
                </mesh>
              )}
              {growth > 0.1 && (
                <group position={[xPos, targetY, 0]}>
                  <Sphere args={[0.3, 16, 16]}><meshStandardMaterial color={item.color} emissive={item.color} emissiveIntensity={active ? 10 : 2} /></Sphere>
                  <Billboard position={[0, 5, 0]}>
                    <Text position={[0, 2, 0]} fontSize={2.5}>{item.flag}</Text>
                    <Text position={[0, 0.5, 0]} fontSize={0.8} color="#fff">{item.name}</Text>
                    <Text position={[0, -0.8, 0]} fontSize={1.5} fontWeight="bold" color={active ? "#fff" : item.color}>{(item.value * (progress > index + 1 ? 1 : growth)).toFixed(1)}</Text>
                  </Billboard>
                </group>
              )}
            </group>
          );
        };

        const CameraManager = ({ view, progress, data }) => {
          const { camera } = useThree();
          const controls = useRef();
          const currentIdx = Math.max(0, Math.min(data.length - 1, progress));
          const xPos = (currentIdx - (data.length - 1) / 2) * 3.5;

          useFrame(() => {
            if (view === CameraView.CINEMATIC) {
              controls.current?.target.lerp(new THREE.Vector3(xPos, 5, 0), 0.05);
              camera.position.lerp(new THREE.Vector3(xPos + 25, 15, 40), 0.05);
            } else if (view === CameraView.PANORAMA) {
              controls.current?.target.lerp(new THREE.Vector3(0, 0, 0), 0.04);
              camera.position.lerp(new THREE.Vector3(0, 30, 80), 0.04);
            }
            controls.current?.update();
          });
          return <OrbitControls ref={controls} makeDefault enableDamping dampingFactor={0.05} enabled={view === CameraView.FREE} />;
        };

        // ==========================================
        // 3. ‰∏ªÈ°µÈù¢
        // ==========================================
        const App = () => {
          const [progress, setProgress] = useState(0);
          const [isPlaying, setIsPlaying] = useState(true);
          const [mode, setMode] = useState(CONFIG.ui.defaultMode);
          const [view, setView] = useState(CameraView.CINEMATIC);

          useEffect(() => {
            if (!isPlaying) return;
            const step = () => {
              setProgress(p => {
                if (p >= CONFIG.data.length) { setIsPlaying(false); setView(CameraView.PANORAMA); return CONFIG.data.length; }
                return p + 0.005;
              });
              requestAnimationFrame(step);
            };
            const id = requestAnimationFrame(step);
            return () => cancelAnimationFrame(id);
          }, [isPlaying]);

          return (
            <div className="w-full h-full flex flex-col bg-black overflow-hidden">
              <div className="flex-grow relative">
                <div className="absolute top-8 left-8 z-20 pointer-events-none">
                  <h1 className="text-3xl font-black italic">{CONFIG.ui.title} <span className="text-blue-500">{CONFIG.ui.highlightTitle}</span></h1>
                  <p className="text-blue-400 text-[10px] tracking-[0.4em] font-bold opacity-60 uppercase">{CONFIG.ui.subTitle}</p>
                </div>

                <Canvas dpr={[1, 2]} shadows>
                  <Suspense fallback={null}>
                    <Environment preset="night" />
                    <CameraManager view={view} progress={progress} data={CONFIG.data} />
                    <Grid infiniteGrid fadeDistance={150} sectionColor="#111" cellColor="#050505" />
                    <group key={mode}>
                      {CONFIG.data.map((item, i) => (
                        mode === 'BAR' ? 
                        <Bar key={item.id} item={item} index={i} total={CONFIG.data.length} progress={progress} active={Math.floor(progress) === i} /> :
                        <LineNode key={item.id} item={item} prevItem={i>0?CONFIG.data[i-1]:null} index={i} total={CONFIG.data.length} progress={progress} active={Math.floor(progress) === i} />
                      ))}
                    </group>
                    <mesh rotation={[-Math.PI/2, 0, 0]} position={[0, -0.05, 0]}>
                      <planeGeometry args={[1000, 1000]} />
                      <MeshReflectorMaterial mirror={0.8} color="#050505" metalness={0.5} />
                    </mesh>
                  </Suspense>
                </Canvas>
              </div>

              <div className="bg-[#080808] border-t border-white/5 p-6 flex flex-col items-center gap-4 z-30">
                <div className="w-full max-w-4xl h-1 bg-white/10 rounded-full overflow-hidden">
                  <div className="h-full bg-blue-600 transition-all duration-300" style={{ width: `${(progress / CONFIG.data.length) * 100}%` }} />
                </div>
                <div className="flex items-center gap-6">
                  <button onClick={() => setIsPlaying(!isPlaying)} className="p-4 bg-blue-600 rounded-full hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/20">{isPlaying ? <Pause size={24} /> : <Play size={24} />}</button>
                  <button onClick={() => { setProgress(0); setIsPlaying(true); setView(CameraView.CINEMATIC); }} className="p-4 bg-white/5 rounded-full hover:bg-white/10"><RotateCcw size={20} /></button>
                  <div className="h-8 w-[1px] bg-white/10 mx-2" />
                  <button onClick={() => setMode(m => m === 'BAR' ? 'LINE' : 'BAR')} className="px-6 py-3 bg-white/5 border border-white/10 rounded-xl text-xs font-black tracking-widest uppercase hover:bg-white/10 transition-all">
                    ÂΩìÂâçÊ®°Âºè: {mode === 'BAR' ? 'Êü±Áä∂Âõæ' : 'ÊäòÁ∫øÂõæ'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
